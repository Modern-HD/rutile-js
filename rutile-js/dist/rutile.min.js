let DANGER_WORD=["javascript","script","<iframe","vbscript","applet","embed","<object","<frame","onblur","onchange","onclick","ondblclick","enerror","onfocus","onload","onmouse","onscroll","onsubmit","onunload","onerror"],replaceTargetFunc=[{origin:"onClick",fix:"onclick"},{origin:"onChange",fix:"onchange"},{origin:"onInput",fix:"oninput"}],funcPrepareMap=new Map,domRefMap=new Map,domReadyMap=new Map,stateMap=new Map,globalStateMap=new Map;function*idxGenerator(e){let t=0,a=0;for(;;)a>=Number.MAX_SAFE_INTEGER&&(t++,a=0),yield`__${e}_${t}_${a++}_`}let funcIdxGen=idxGenerator("FUNC"),domIdxGen=idxGenerator("DOM_REF"),domReadyIdxGen=idxGenerator("DOM_READY"),stateIdxGen=idxGenerator("DOM_SUBS"),subsCallbackIdxGen=idxGenerator("DOM_SUBS_CALL_BACK"),Rutile={render(e,t,a){let l=RegExp(DANGER_WORD.join("|"),"gi"),r=e.replaceAll(l,"x"),n=document.createElement("div"),o=[];n.innerHTML=r,replaceTargetFunc.forEach((e,t)=>{n.querySelectorAll(`div [data-func_prepare_${t}]`).forEach(a=>{let l,r=a.dataset[`func_prepare_${t}`];(l=funcPrepareMap.get(r))&&(a[e.fix]=l),delete a.dataset[`func_prepare_${t}`],n.querySelector(`[data-func_prepare_${t}="${r}"]`)||funcPrepareMap.delete(r)})}),n.querySelectorAll("div [ref]").forEach(e=>{let t=e.getAttribute("ref");domRefMap.get(t).current=e,e.removeAttribute("ref"),domRefMap.delete(t)}),n.querySelectorAll("div dom-ready-event[data-dom_ready]").forEach(e=>{let t=e.dataset.dom_ready;o.push(domReadyMap.get(t)),domReadyMap.delete(t),e.remove()}),n.querySelectorAll("div state-subs").forEach(e=>{if(!(e instanceof HTMLElement))return;let t=e.dataset.dom_subs,a=e.dataset.dom_global_subs;if(!(t||a))return;let l=t?stateMap.get(t):globalStateMap.get(a);if(!l)return;let r=e.dataset.dom_subs_component,n=e.dataset.dom_subs_callback,s=n?l.callbackMap.get(n):void 0;r?o.push(()=>{Rutile.render(Rutile.build(s?`${s(l.value)}`:l.value),e)}):s?e.innerText=safeXSS(`${s(l.value)}`):e.innerText=safeXSS(`${l.value}`),l.subsList.push({elem:e,callback:s,component:r&&"true"===r}),delete e.dataset.dom_subs,r&&delete e.dataset.dom_subs_component,n&&delete e.dataset.dom_subs_callback,a&&delete e.dataset.dom_global_subs,s&&l.callbackMap.delete(n)}),n.querySelectorAll("div script").forEach(e=>{e.remove()}),a&&a.append||(t.innerHTML=""),Array.from(n.children).forEach(e=>{t.appendChild(e)}),o.forEach(e=>e()),stateMap.forEach((e,t)=>{e.subsList=e.subsList.filter(e=>document.contains(e.elem)),0===e.subsList.length&&stateMap.delete(t)})},build(e,t){if(!t)return e;let a=e;if(t.eventPrepare&&replaceTargetFunc.forEach((e,l)=>{let r=`${e.origin}="{(.*?)}"`,n=RegExp(r,"g"),o;for(let s of a.matchAll(n)){let u=s[1];if(o&&o===u||(o=u,!t.eventPrepare[u]))continue;let d=funcIdxGen.next().value;a=a.replaceAll(`${e.origin}="{${u}}"`,`data-func_prepare_${l}="${d}"`),funcPrepareMap.set(d,t.eventPrepare[u])}}),t.stylePrepare){let l=RegExp('style="({.*?})\\"',"g");for(let r of a.matchAll(l)){let n=r[1].substring(1,r[1].length-1);if(!t.stylePrepare[n])continue;let o="";for(let s in t.stylePrepare[n])o+=`${kebabStyleProperty(s)}: ${t.stylePrepare[n][s]}; `;a=a.replaceAll(`{${n}}`,o)}}if(t.domReady){if(t.domReady instanceof Function){let u=[];u.push(t.domReady),t.domReady=u}t.domReady instanceof Array&&t.domReady.forEach(e=>{let t=domReadyIdxGen.next().value;domReadyMap.set(t,e),a+=`<dom-ready-event data-dom_ready="${t}"></dom-ready-event> `})}return a},domRef(){let e={current:null,set:domIdxGen.next().value};return domRefMap.set(e.set,e),e},createState(e){let t=stateIdxGen.next().value,a={value:e,subsList:[],callbackMap:new Map};return stateMap.set(t,a),[{subs(e="inline",l){e instanceof Function&&(l=e,e="inline");let r=`<state-subs data-dom_subs="${t}" ${"block"===e?'style="display: block;"':""} `;if("component"===e&&(r+='data-dom_subs_component="true" '),l instanceof Function){let n=subsCallbackIdxGen.next().value;r+=`data-dom_subs_callback="${n}" `,a.callbackMap.set(n,l)}return r+"></state-subs>"},getState:()=>a.value instanceof Object?{...a.value}:a.value instanceof Array?[...a.value]:a.value},e=>{a.value!==e&&(a.value=e,rerenderState(a))}]},createGlobalState(e){if(globalStateMap.has(e.key))throw new DuplicateKeyError("globalState에서는 중복된 키를 사용하실 수 없습니다.");let t={value:e.default,default:e.default,subsList:[],callbackMap:new Map};globalStateMap.set(e.key,t);let a=t.default instanceof Object?{...t.default}:t.default instanceof Array?[...t.default]:t.default;return{stateKey:e.key,defaultValue:a}},getGlobalState:e=>({subs(t="inline",a){t instanceof Function&&(a=t,t="inline");let l=`<state-subs data-dom_global_subs="${e.stateKey}" ${"block"===t?'style="display: block;"':""} `;"component"===t&&(l+='data-dom_subs_component="true" ');let r=globalStateMap.get(e.stateKey);if(a instanceof Function){let n=subsCallbackIdxGen.next().value;l+=`data-dom_subs_callback="${n}" `,r.callbackMap.set(n,a)}return l+"></state-subs>"},getState(){let t=globalStateMap.get(e.stateKey);return t.value instanceof Object?{...t.value}:t.value instanceof Array?[...t.value]:t.value}}),setGlobalState:e=>t=>{let a=globalStateMap.get(e.stateKey);a.value!==t&&(a.value=t,a.subsList=a.subsList.filter(e=>document.contains(e.elem)),rerenderState(a))},useGlobalState:e=>[Rutile.getGlobalState(e),Rutile.setGlobalState(e)],resetGlobalState(e){let t=globalStateMap.get(e.stateKey);t.value!==t.default&&(t.value=t.default,t.subsList=t.subsList.filter(e=>document.contains(e.elem)),rerenderState(t))}};class DuplicateKeyError extends Error{constructor(e){super(e),this.name="DuplicateKeyError"}}export function safeXSS(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function rerenderState(e){e.subsList.forEach(t=>{t.component?Rutile.render(Rutile.build(t.callback?`${t.callback(e.value)}`:e.value),t.elem):t.callback?t.elem.innerText=safeXSS(`${t.callback(e.value)}`):t.elem.innerText=safeXSS(`${e.value}`)})}function kebabStyleProperty(e){return e.split("").map((e,t)=>{let a=e.toLowerCase();return e!==a&&t>0?"-"+a:a}).join("")}export default Rutile;